<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traffic Vision AI | Command Center</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script> <!-- Mock FA -->
    <!-- Using a CDN for icons for immediate visual impact (FontAwesome equivalent) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        .map-section {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Side Navigation -->
        <aside class="sidebar glass-panel">
            <div class="logo-area">
                <div
                    style="width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--purple));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;color:white;flex-shrink:0;">
                    <i class="fas fa-camera-retro"></i>
                </div>
                <h2 style="font-size:1.05rem;font-weight:800;letter-spacing:-0.3px;line-height:1.15;">Traffic<br>Vision
                    AI</h2>
            </div>

            <nav class="nav-menu">
                <a href="{{ url_for('dashboard') }}" class="nav-item active">
                    <i class="fas fa-th-large"></i> Command Center
                </a>
                <a href="{{ url_for('analysis') }}" class="nav-item">
                    <i class="fas fa-chart-line"></i> Analytics
                </a>
                <a href="{{ url_for('ambulance_portal') }}" class="nav-item" target="_blank">
                    <i class="fas fa-truck-medical"></i> Ambulance Unit
                </a>
                <div class="nav-divider"></div>
                <div class="control-group">
                    <label class="switch-label">
                        <i class="fas fa-hand-paper"></i> Manual Override
                        <input type="checkbox" id="manual-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div
                    style="font-size:0.6rem;color:var(--text-secondary);letter-spacing:0.5px;padding:0.6rem 1rem 0.4rem;opacity:0.6;">
                    TRAFFIC VISION AI v3.0</div>
                <a href="{{ url_for('logout') }}" class="nav-item logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Status Bar -->
            <header class="top-bar glass-panel">
                <div class="status-group">
                    <div class="status-indicator">
                        <span class="dot online"></span>
                        <div class="status-text">
                            <span class="label">SYSTEM STATUS</span>
                            <span class="value">OPERATIONAL</span>
                        </div>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-indicator">
                        <i class="fas fa-clock" style="color: var(--text-secondary);"></i>
                        <div class="status-text">
                            <span class="label">NEXT SWITCH</span>
                            <span class="value" id="timer">--s</span>
                        </div>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-indicator" id="ambu-status" style="opacity: 0.5;">
                        <i class="fas fa-ambulance" style="color: var(--danger);"></i>
                        <div class="status-text">
                            <span class="label">EMERGENCY MODE</span>
                            <span class="value" id="ambu-text">INACTIVE</span>
                        </div>
                    </div>
                    <div class="status-divider"></div>
                    <div class="status-indicator">
                        <i class="fas fa-satellite-dish" style="color:var(--purple);"></i>
                        <div class="status-text">
                            <span class="label">LIVE CLOCK</span>
                            <span class="value" id="live-clock"
                                style="color:var(--accent);font-variant-numeric:tabular-nums;">--:--</span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn-icon" onclick="document.getElementById('setup-modal').style.display='flex'">
                        <i class="fas fa-cog"></i> Configure Sources
                    </button>
                </div>
            </header>

            <!-- Summary Stats -->
            <div class="summary-stats">
                <div class="summary-card">
                    <div class="s-icon" style="background:var(--accent-dim);color:var(--accent);"><i
                            class="fas fa-car-side"></i></div>
                    <div class="s-data"><span class="s-val" id="stat-total-vehicles">0</span><span class="s-lbl">Total
                            Vehicles</span></div>
                </div>
                <div class="summary-card">
                    <div class="s-icon" style="background:var(--danger-dim);color:var(--danger);"><i
                            class="fas fa-triangle-exclamation"></i></div>
                    <div class="s-data"><span class="s-val" id="stat-incidents">0</span><span class="s-lbl">Active
                            Incidents</span></div>
                </div>
                <div class="summary-card">
                    <div class="s-icon" style="background:var(--success-dim);color:var(--success);"><i
                            class="fas fa-brain"></i></div>
                    <div class="s-data"><span class="s-val" id="stat-accuracy">98.2%</span><span class="s-lbl">AI
                            Accuracy</span></div>
                </div>
                <div class="summary-card">
                    <div class="s-icon" style="background:rgba(139,92,246,0.1);color:var(--purple);"><i
                            class="fas fa-server"></i></div>
                    <div class="s-data"><span class="s-val" id="stat-uptime">--</span><span class="s-lbl">System
                            Uptime</span></div>
                </div>
            </div>

            <!-- Video Grid -->
            <div class="video-grid">
                {% for i in range(4) %}
                <div class="lane-card glass-panel" id="lane-{{i}}">
                    <div class="lane-header">
                        <span class="lane-badge">LANE 0{{ i + 1 }}</span>
                        <div class="signal-pill" id="signal-pill-{{i}}">
                            <span class="signal-dot" id="signal-dot-{{i}}"></span>
                            <span class="signal-text" id="signal-text-{{i}}">RED</span>
                        </div>
                    </div>

                    <div class="video-wrapper">
                        <img id="video-lane-{{i}}" src="{{ url_for('static', filename='placeholder.png') }}"
                            data-placeholder="{{ url_for('static', filename='placeholder.png') }}"
                            onerror="this.onerror=null; this.src=this.dataset.placeholder;">

                        <div class="manual-overlay" id="manual-overlay-{{i}}">
                            <button class="btn-force" onclick="forceSignal('{{i}}')">
                                <i class="fas fa-power-off"></i> FORCE GREEN
                            </button>
                        </div>

                        <!-- Scan Line Animation -->
                        <div class="scan-line"></div>
                    </div>

                    <div class="lane-stats">
                        <div class="stat-row">
                            <div class="stat-item" title="Cars">
                                <i class="fas fa-car"></i> <span id="count-car-{{i}}">0</span>
                            </div>
                            <div class="stat-item" title="Trucks/Buses">
                                <i class="fas fa-truck"></i> <span id="count-truck-{{i}}">0</span>
                            </div>
                            <div class="stat-item" title="Motorcycles">
                                <i class="fas fa-motorcycle"></i> <span id="count-bike-{{i}}">0</span>
                            </div>
                        </div>
                        <div class="total-density">
                            <span>TOTAL: <strong id="total-{{i}}">0</strong></span>
                            <span class="density-tag" id="density-{{i}}">LOW</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </main>

        <!-- Right Panel: Live Logs -->
        <aside class="info-sidebar glass-panel">
            <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> Incident Reports</h3>
            <div class="log-container" id="user-reports"
                style="max-height: 180px; min-height: 60px; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.06);">
                <div class="log-item info">
                    <span class="msg">No accident reports.</span>
                </div>
            </div>

            <h3><i class="fas fa-truck-medical" style="color:var(--accent);"></i> Dispatch History</h3>
            <div id="dispatch-history"
                style="max-height:140px;min-height:40px;overflow-y:auto;margin-bottom:0.75rem;padding-bottom:0.5rem;border-bottom:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:0.72rem;color:var(--text-secondary);text-align:center;padding:8px;">No dispatches
                    yet.</div>
            </div>

            <h3><i class="fas fa-history" style="color:var(--purple);"></i> Event Log</h3>
            <div class="log-container" id="event-log" style="flex-grow:1;">
                <div class="log-item system">
                    <span class="time">System</span>
                    <span class="msg">Dashboard initialized. Monitor active.</span>
                </div>
            </div>
        </aside>
    </div>

    <!-- Setup Modal -->
    <div id="setup-modal" class="modal-overlay" style="display: none;">
        <div class="modal glass-panel">
            <div class="modal-header">
                <h3><i class="fas fa-video"></i> Video Source Configuration</h3>
                <button onclick="document.getElementById('setup-modal').style.display='none'"
                    class="close-btn">&times;</button>
            </div>
            <form action="{{ url_for('setup_demo') }}" method="post" enctype="multipart/form-data">
                <div class="input-grid">
                    {% for i in range(4) %}
                    <div class="input-group">
                        <label>Lane {{i+1}} Source</label>
                        <input type="text" name="cam_{{i+1}}" placeholder="Camera Index (0) or URL" class="mb-2"
                            style="width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #444; background: #0f172a; color: white;">
                        <div style="text-align: center; font-size: 0.8rem; opacity: 0.7; margin: 4px 0;">OR UPLOAD FILE
                        </div>
                        <input type="file" name="video_{{i+1}}" accept="video/*">
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn-primary">Initialize Simulation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Live Map Section (Below videos) -->
    <div class="glass-panel" style="margin-top: 20px; padding: 20px; position: relative;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-map-marked-alt" style="color: var(--accent);"></i> Live Incident Map
                <span
                    style="font-size: 0.8rem; opacity: 0.6; font-weight: normal; background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px;">Real-time</span>
            </h3>
            <div
                style="display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.3); padding: 6px 14px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);">
                <!-- Map Type Toggle -->
                <i class="fas fa-satellite" id="map-type-icon"
                    style="color: var(--text-secondary); transition: 0.3s;"></i>
                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">Satellite</span>
                <label class="custom-toggle" style="margin-right: 15px;">
                    <input type="checkbox" id="map-type-toggle">
                    <span class="custom-slider"></span>
                </label>

                <!-- Traffic Toggle -->
                <i class="fas fa-car-side" id="traffic-icon"
                    style="color: var(--text-secondary); transition: 0.3s;"></i>
                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">Traffic</span>
                <label class="custom-toggle" style="margin-right: 15px;">
                    <input type="checkbox" id="traffic-toggle-btn">
                    <span class="custom-slider"></span>
                </label>

                <!-- Track Location Toggle -->
                <i class="fas fa-crosshairs" id="locate-icon"
                    style="color: var(--text-secondary); transition: 0.3s;"></i>
                <span style="font-size: 0.9rem; font-weight: 600; color: var(--text-primary);">Track</span>
                <label class="custom-toggle">
                    <input type="checkbox" id="locate-toggle-btn">
                    <span class="custom-slider"></span>
                </label>
            </div>
        </div>

        <!-- Add dynamic map overlay -->
        <div style="position: relative;">
            <div id="admin-map" class="map-section"
                style="border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
            </div>
            <!-- Innovative Scanner UI Overlay -->
            <div id="map-scanner"
                style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent 95%, rgba(59,130,246,0.5) 100%); background-size: 100% 200%; pointer-events: none; z-index: 1000; display: none; border-radius: 12px; animation: scanMap 1.5s infinite linear;">
            </div>
        </div>
    </div>

    <!-- Styles for the new features -->
    <style>
        @keyframes scanMap {
            0% {
                background-position: 0% -100%;
            }

            100% {
                background-position: 0% 100%;
            }
        }

        @keyframes locPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(3.5);
                opacity: 0;
            }
        }

        .custom-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .custom-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .custom-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .4s;
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .custom-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.custom-slider {
            background-color: rgba(16, 185, 129, 0.2);
            border-color: var(--success);
            box-shadow: inset 0 0 10px rgba(16, 185, 129, 0.2);
        }

        input:checked+.custom-slider:before {
            transform: translateX(20px);
            background-color: var(--success);
            box-shadow: 0 0 10px var(--success);
        }

        .loc-marker-pulse {
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            animation: locPulse 1.5s infinite cubic-bezier(0.215, 0.610, 0.355, 1);
        }
    </style>

    <script>
        // State
        let manualMode = false;
        const startTime = Date.now();

        // --- Live Clock ---
        function updateClock() {
            document.getElementById('live-clock').textContent =
                new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
        }
        setInterval(updateClock, 1000); updateClock();

        // --- System Uptime ---
        function updateUptime() {
            const s = Math.floor((Date.now() - startTime) / 1000);
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            document.getElementById('stat-uptime').textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
        }
        setInterval(updateUptime, 10000); updateUptime();

        // --- Summary Stats ---
        function updateSummaryStats() {
            // Total vehicles across all lanes
            let total = 0;
            for (let i = 0; i < 4; i++) {
                const el = document.getElementById(`total-${i}`);
                if (el) total += parseInt(el.textContent || '0');
            }
            document.getElementById('stat-total-vehicles').textContent = total;
        }

        // --- Dispatch History ---
        function updateDispatchHistory() {
            fetch('/api/dispatch/active?t=' + Date.now())
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('dispatch-history');
                    if (!data.dispatches || data.dispatches.length === 0) {
                        container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-secondary);text-align:center;padding:8px;">No active dispatches.</div>';
                        return;
                    }
                    let html = '';
                    data.dispatches.forEach(d => {
                        const statusMap = { 'Dispatched': 'dispatched', 'En Route': 'enroute', 'Arrived': 'arrived', 'Patient Loaded': 'arrived' };
                        const cls = statusMap[d.status] || 'dispatched';
                        html += `<div class="dispatch-mini">
                            <div class="dm-top">
                                <span style="font-weight:600;color:var(--text-primary);">#${d.id} — ${d.hospital_name || 'Unknown'}</span>
                                <span class="dm-status ${cls}">${d.status}</span>
                            </div>
                            <div style="color:var(--text-secondary);font-size:0.65rem;">${d.description || 'Emergency dispatch'} • ${d.timestamp}</div>
                        </div>`;
                    });
                    container.innerHTML = html;
                })
                .catch(() => { });
        }
        setInterval(updateDispatchHistory, 5000);
        setTimeout(updateDispatchHistory, 1000);

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Stats update on a loop
            setInterval(updateSummaryStats, 1500);
        });

        document.getElementById('manual-mode-toggle').addEventListener('change', (e) => {
            manualMode = e.target.checked;
            document.querySelectorAll('.manual-overlay').forEach(el => {
                el.style.opacity = manualMode ? '1' : '0';
                el.style.pointerEvents = manualMode ? 'all' : 'none';
            });
            logEvent('System', `Manual Override ${manualMode ? 'ENABLED' : 'DISABLED'}`);

            try {
                const msg = new SpeechSynthesisUtterance(`Manual Override ${manualMode ? 'Activated' : 'Deactivated'}`);
                window.speechSynthesis.speak(msg);
            } catch (e) { }
        });

        function forceSignal(laneId) {
            if (!manualMode) return;

            fetch('/api/override', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lane_id: laneId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        logEvent('Manual', `Lane ${laneId + 1} forced GREEN`);
                    } else {
                        logEvent('Error', 'Failed to override signal');
                    }
                });
        }

        // --- Logging System ---
        function logEvent(type, message) {
            const container = document.getElementById('event-log');
            const item = document.createElement('div');
            item.className = `log-item ${type.toLowerCase()}`;
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            item.innerHTML = `<span class="time">${time}</span><span class="msg">${message}</span>`;

            container.insertBefore(item, container.firstChild);

            // Limit log size
            if (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        // --- Polling Logic ---
        function updateStatus() {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    const status = data.signal_status;
                    const lanes = data.lane_data;

                    // 1. Timer
                    document.getElementById('timer').innerText = status.remaining_time + 's';

                    // 2. Ambulance Status
                    const ambuInd = document.getElementById('ambu-status');
                    const ambuText = document.getElementById('ambu-text');
                    if (status.ambulance_mode) {
                        ambuInd.style.opacity = '1';
                        ambuInd.classList.add('pulse-danger');
                        ambuText.innerText = 'DETECTED';
                        ambuText.style.color = 'var(--danger)';

                        // Check if we logged this recently? (Mock logic to avoid spam)
                        if (!window.lastAmbuState) {
                            logEvent('Emergency', 'Ambulance detected on approaching lane!');

                            try {
                                const msg = new SpeechSynthesisUtterance("Emergency vehicle detected. Prioritizing traffic signal.");
                                window.speechSynthesis.speak(msg);
                            } catch (e) { }
                        }
                    } else {
                        ambuInd.style.opacity = '0.5';
                        ambuInd.classList.remove('pulse-danger');
                        ambuText.innerText = 'INACTIVE';
                        ambuText.style.color = 'var(--text-secondary)';
                    }
                    window.lastAmbuState = status.ambulance_mode;

                    // 3. Lane Updates
                    for (let i = 0; i < 4; i++) {
                        // Signal
                        const state = status.states[i]; // RED, GREEN, YELLOW
                        const pill = document.getElementById(`signal-pill-${i}`);
                        const dot = document.getElementById(`signal-dot-${i}`);
                        const text = document.getElementById(`signal-text-${i}`);
                        const laneCard = document.getElementById(`lane-${i}`);

                        // Reset classes
                        pill.className = 'signal-pill';
                        dot.className = 'signal-dot';

                        pill.classList.add(state);
                        dot.classList.add(state);
                        text.innerText = state;

                        // Active Green Frame Logic
                        if (state === 'GREEN') {
                            laneCard.classList.add('active-green-lane');
                        } else {
                            laneCard.classList.remove('active-green-lane');
                        }

                        // Stats
                        const d = lanes[i.toString()];
                        if (d) {
                            document.getElementById(`total-${i}`).innerText = d.count;
                            document.getElementById(`density-${i}`).innerText = d.density;

                            // Detailed Breakdown (Mock if empty, or real if backend sends it)
                            const details = d.details || {};
                            document.getElementById(`count-car-${i}`).innerText = details.car || details.Car || 0;
                            document.getElementById(`count-truck-${i}`).innerText = (details.truck || 0) + (details.bus || 0);
                            document.getElementById(`count-bike-${i}`).innerText = (details.motorcycle || 0) + (details.bicycle || 0);
                        }
                    }
                });
        }

        function updateVideos() {
            const t = new Date().getTime();
            for (let i = 0; i < 4; i++) {
                const img = document.getElementById(`video-lane-${i}`);
                if (img) {
                    // Preload to avoid flicker
                    const newSrc = `/video_snapshot/${i}?t=${t}`;
                    const loader = new Image();
                    loader.onload = () => { img.src = newSrc; };
                    loader.src = newSrc;
                }
            }
        }

        setInterval(updateStatus, 1000);
        setInterval(updateVideos, 100); // 10 FPS
        setInterval(updateReports, 5000); // Poll user reports every 5s

        // --- User Reports ---
        let lastReportId = 0;
        function updateReports() {
            fetch('/user/api/reports')
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('user-reports');

                    // Update incident count in summary
                    const activeCount = data.reports.filter(r => r.status !== 'Resolved').length;
                    document.getElementById('stat-incidents').textContent = activeCount;

                    if (data.reports.length === 0) {
                        return; // keeping placeholder
                    }

                    // clear placeholder if first real load
                    if (container.querySelector('.info .msg')?.textContent === 'No accident reports.') {
                        container.innerHTML = '';
                    }

                    // Simple diff check or just rebuild for simplicity in this demo
                    // To avoid flicker, we only append *new* ones, but let's just rebuild sorted
                    // Actually, let's just highlight new ones.

                    // rebuild content
                    let html = '';
                    data.reports.forEach(r => {
                        const icon = r.status === 'Resolved' ? 'check-circle' : 'exclamation-circle';
                        const color = r.status === 'Resolved' ? 'green' : (r.status === 'Verified' ? 'orange' : 'red');

                        html += `
                        <div class="log-item" style="border-left: 3px solid ${color}; background: rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s;" onclick="focusAccident(${r.latitude || 'null'}, ${r.longitude || 'null'}, ${r.id})" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                            <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                <span style="color:var(--text); font-weight:bold;">${r.location}</span>
                                <span class="time">${r.timestamp}</span>
                            </div>
                            <span class="msg" style="color:#ccc;">${r.description || 'No details'}</span>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                                <div style="font-size:0.75rem; color:${color}">
                                    <i class="fas fa-${icon}"></i> ${r.status}
                                </div>
                                ${r.status !== 'Resolved' ? `<button onclick="alertAmbulance(event, ${r.id}, ${r.latitude || 'null'}, ${r.longitude || 'null'})" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; display: flex; align-items: center; gap: 4px; z-index: 10;"><i class="fas fa-truck-medical"></i> Alert Ambulance</button>` : ''}
                            </div>
                        </div>`;

                        if (r.id > lastReportId) {
                            lastReportId = r.id;
                            // Trigger a toast or sound?
                            logEvent('ALERT', `New Incident Reported at ${r.location}`);
                            // Play sound if needed
                        }
                    });

                    container.innerHTML = html;

                    // Update Map Markers
                    updateMapMarkers(data.reports);

                })
                .catch(e => console.error("Report fetch error:", e));
        }

        function focusAccident(lat, lng, id) {
            if (lat !== null && lng !== null) {
                map.flyTo([lat, lng], 16, { animate: true, duration: 1.5 });

                // If a map marker exists, simulate opening its popup after the animation
                if (markers[id]) {
                    setTimeout(() => {
                        markers[id].openPopup();
                    }, 1500);
                }
            } else {
                logEvent('System', "No geographic coordinates available for this location.");
            }
        }

        function alertAmbulance(event, id, lat, lng) {
            event.stopPropagation();

            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
            btn.style.pointerEvents = 'none';

            if (lat === null || lat === undefined || lng === null || lng === undefined) {
                btn.innerHTML = '<i class="fas fa-times"></i> No GPS Data';
                return;
            }

            // Real-time API query using OpenStreetMap Overpass (Free, No Auth required)
            // Finds ALL real hospitals within a 10km radius, then picks the closest one
            const query = `
                [out:json];
                (
                  node["amenity"="hospital"](around:10000,${lat},${lng});
                  way["amenity"="hospital"](around:10000,${lat},${lng});
                );
                out center;
            `;

            fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    let facilityName = "Nearest Response Center";
                    let fLat = null;
                    let fLng = null;

                    if (data.elements && data.elements.length > 0) {
                        // Haversine distance calculator (in meters)
                        function haversine(lat1, lon1, lat2, lon2) {
                            const R = 6371000;
                            const dLat = (lat2 - lat1) * Math.PI / 180;
                            const dLon = (lon2 - lon1) * Math.PI / 180;
                            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                                Math.sin(dLon / 2) * Math.sin(dLon / 2);
                            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                        }

                        // Extract coordinates for each hospital and calculate distance
                        const hospitals = data.elements.map(el => {
                            const hLat = el.lat || (el.center ? el.center.lat : null);
                            const hLng = el.lon || (el.center ? el.center.lon : null);
                            const name = (el.tags && el.tags.name) ? el.tags.name : null;
                            if (hLat === null || hLng === null || !name) return null;
                            return {
                                name: name,
                                lat: hLat,
                                lng: hLng,
                                dist: haversine(lat, lng, hLat, hLng)
                            };
                        }).filter(h => h !== null);

                        // Sort by distance ascending and pick the closest
                        hospitals.sort((a, b) => a.dist - b.dist);

                        if (hospitals.length > 0) {
                            const closest = hospitals[0];
                            facilityName = closest.name;
                            fLat = closest.lat;
                            fLng = closest.lng;
                            console.log(`Found ${hospitals.length} hospitals. Closest: ${facilityName} (${(closest.dist / 1000).toFixed(1)} km)`);
                        }
                    }

                    btn.innerHTML = '<i class="fas fa-check"></i> Dispatched';
                    btn.style.background = 'var(--success)';

                    // Save dispatch to backend database so the Ambulance Driver Portal receives it
                    fetch('/api/dispatch', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            report_id: id,
                            hospital_name: facilityName,
                            hospital_lat: fLat,
                            hospital_lng: fLng,
                            accident_lat: lat,
                            accident_lng: lng,
                            distance_km: fLat !== null ? (map.distance([fLat, fLng], [lat, lng]) / 1000) : null
                        })
                    });

                    // Log to the internal console
                    logEvent('Emergency', `Dispatched unit from ${facilityName} to Incident #${id}`);

                    if (fLat !== null && fLng !== null) {
                        // Plot the hospital on the map
                        const hospitalMarker = L.circleMarker([fLat, fLng], {
                            radius: 10,
                            fillColor: "#3b82f6", // Medical Blue
                            color: "#fff",
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.9
                        }).addTo(map);

                        hospitalMarker.bindPopup(`<b>${facilityName}</b><br>Responding to Incident #${id}`).openPopup();

                        // Draw real-time dispatch vector (line) back to accident point
                        const routeLine = L.polyline([[fLat, fLng], [lat, lng]], {
                            color: '#3b82f6',
                            weight: 4,
                            dashArray: '10, 10',
                            className: 'route-animation'
                        }).addTo(map);

                        // Calculate real geographical distance using map engine
                        const distanceStr = (map.distance([fLat, fLng], [lat, lng]) / 1000).toFixed(1);

                        // Focus camera to frame both the hospital and the accident scene
                        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

                        // Voice synthesis notification specifically for the guide
                        try {
                            const speechMsg = `Emergency recorded. Locating nearest medical facility. Alerting ${facilityName}, located ${distanceStr} kilometers away. Ambulance dispatched.`;
                            const msg = new SpeechSynthesisUtterance(speechMsg);
                            window.speechSynthesis.speak(msg);
                        } catch (e) { }
                    } else {
                        // Fallback if we are in the middle of nowhere on OSM
                        try {
                            const msg = new SpeechSynthesisUtterance("Nearest available response center has been alerted and routed to the accident location.");
                            window.speechSynthesis.speak(msg);
                        } catch (e) { }
                    }
                })
                .catch(err => {
                    btn.innerHTML = '<i class="fas fa-check"></i> Dispatched';
                    btn.style.background = 'var(--success)';
                    logEvent('Emergency', `Offline Fallback: Alerted nearest unit for #${id}`);
                    try {
                        const msg = new SpeechSynthesisUtterance("Nearest available ambulance has been alerted.");
                        window.speechSynthesis.speak(msg);
                    } catch (e) { }
                });
        }

        // --- Map Logic ---
        var map = L.map('admin-map').setView([12.9716, 77.5946], 12);

        // Map Animations CSS
        const mapStyle = document.createElement('style');
        mapStyle.innerHTML = `
            .route-animation {
                stroke-dashoffset: 100;
                animation: dash 2s linear infinite;
            }
            @keyframes dash {
                to { stroke-dashoffset: 0; }
            }
        `;
        document.head.appendChild(mapStyle);

        // Define base layers
        var standardLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
        });

        // Premium Satellite Map
        var satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            attribution: 'Map &copy; Google',
            maxZoom: 20
        });

        // Google Live Traffic Overlay Layer
        var trafficLayer = L.tileLayer('https://mt1.google.com/vt?lyrs=h,traffic&x={x}&y={y}&z={z}', {
            attribution: 'Traffic &copy; Google',
            maxZoom: 20
        });

        // Add default visible layer
        standardLayer.addTo(map);

        // Map Type Toggle Logic
        document.getElementById('map-type-toggle').addEventListener('change', function () {
            var icon = document.getElementById('map-type-icon');
            if (this.checked) {
                map.removeLayer(standardLayer);
                satelliteLayer.addTo(map);
                icon.style.color = 'var(--accent)';
            } else {
                map.removeLayer(satelliteLayer);
                standardLayer.addTo(map);
                icon.style.color = 'var(--text-secondary)';
            }

            // Keep traffic on top if active
            if (document.getElementById('traffic-toggle-btn').checked) {
                trafficLayer.bringToFront();
            }
        });

        // Traffic Toggle Logic
        document.getElementById('traffic-toggle-btn').addEventListener('change', function () {
            var icon = document.getElementById('traffic-icon');
            if (this.checked) {
                trafficLayer.addTo(map);
                icon.style.color = 'var(--warning)'; // Orange for warning/traffic
            } else {
                map.removeLayer(trafficLayer);
                icon.style.color = 'var(--text-secondary)';
            }
        });

        var markers = {}; // id -> marker

        function updateMapMarkers(reports) {
            reports.forEach(r => {
                if (r.latitude && r.longitude) {
                    if (!markers[r.id]) {
                        // Color based on status
                        let color = '#ef4444'; // red
                        if (r.status === 'Verified') color = '#f59e0b'; // orange
                        if (r.status === 'Resolved') color = '#10b981'; // green

                        const marker = L.circleMarker([r.latitude, r.longitude], {
                            radius: 8,
                            fillColor: color,
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        marker.bindPopup(`<b>${r.location}</b><br>${r.description || 'No details'}<br>Status: ${r.status}`);
                        markers[r.id] = marker;
                    }
                }
            });
        }

        // --- Continuous Location Tracking Toggle ---
        document.getElementById('locate-toggle-btn').addEventListener('change', function () {
            var isChecked = this.checked;
            var scanner = document.getElementById('map-scanner');
            var icon = document.getElementById('locate-icon');

            // Clean up previous listeners
            map.off('locationfound');
            map.off('locationerror');

            if (isChecked) {
                // Turn ON Tracking
                icon.className = 'fas fa-spinner fa-spin';
                icon.style.color = 'var(--accent)';
                scanner.style.display = 'block';

                // watch: true keeps tracking the user's live position seamlessly
                map.locate({ watch: true, setView: true, maxZoom: 16 });

                map.on('locationfound', function (e) {
                    var radius = e.accuracy / 2;

                    // Remove previous markers/circles
                    if (window.userMarker) map.removeLayer(window.userMarker);
                    if (window.userCircle) map.removeLayer(window.userCircle);

                    // Add premium avatar/location icon
                    const customLocIcon = L.divIcon({
                        className: 'custom-loc-icon',
                        html: `<div style="width: 16px; height: 16px; background: #fff; border-radius: 50%; border: 4px solid var(--accent); box-shadow: 0 0 15px var(--accent); position: relative; z-index: 10;">
                                   <div class="loc-marker-pulse"></div>
                               </div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    window.userMarker = L.marker(e.latlng, { icon: customLocIcon }).addTo(map)
                        .bindPopup("<div style='text-align:center;'><b>Command Center</b><br>Accuracy: " + Math.round(radius) + " meters</div>");

                    window.userCircle = L.circle(e.latlng, radius, {
                        color: 'var(--accent)',
                        fillColor: 'var(--accent)',
                        fillOpacity: 0.1,
                        weight: 1,
                        dashArray: '4, 4'
                    }).addTo(map);

                    // Reset UI (stop spinning, show success icon)
                    icon.className = 'fas fa-crosshairs';
                    icon.style.color = 'var(--success)';
                    scanner.style.display = 'none'; // Only scan during initial lock
                });

                map.on('locationerror', function (e) {
                    alert("Location access denied or unavailable.");
                    icon.className = 'fas fa-exclamation-triangle';
                    icon.style.color = 'var(--danger)';
                    scanner.style.display = 'none';
                    document.getElementById('locate-toggle-btn').checked = false; // reset toggle visually
                });
            } else {
                // Turn OFF Tracking
                map.stopLocate();

                if (window.userMarker) {
                    map.removeLayer(window.userMarker);
                    window.userMarker = null;
                }
                if (window.userCircle) {
                    map.removeLayer(window.userCircle);
                    window.userCircle = null;
                }

                // Reset UI
                icon.className = 'fas fa-crosshairs';
                icon.style.color = 'var(--text-secondary)';
                scanner.style.display = 'none';
            }
        });
    </script>
</body>

</html>